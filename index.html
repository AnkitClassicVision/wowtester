<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bland.ai Web Agent Widget</title>
    <script src="https://cdn.jsdelivr.net/npm/bland-client-js-sdk@latest/dist/bland-client-js-sdk.umd.js"></script>
</head>
<body>
    <div id="agent-widget">
        <button id="btn">Start Conversation</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_KEY = 'sk-vi2t1655977tdj9x96n3f0mmq878zkb00ph56z0gcuoyj2ditxnaaatg5l99yj4269';

            const createAgent = async () => {
                try {
                    console.log('Creating agent...');
                    const response = await fetch('https://api.bland.ai/v1/agents', {
                        method: 'POST',
                        headers: {
                            'Authorization': API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "prompt": "You are role-playing an optometry patient. Wait for a reply from the agent and then follow the pathway."
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error creating agent: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('Agent created successfully:', data.agent.agent_id);
                    return data.agent.agent_id;
                } catch (error) {
                    console.error('Error creating agent:', error);
                    alert('Failed to create agent. Please try again.');
                }
            };

            const authorizeAgent = async (agentId) => {
                try {
                    console.log('Authorizing agent...');
                    const response = await fetch(`https://api.bland.ai/v1/agents/${agentId}/authorize`, {
                        method: 'POST',
                        headers: {
                            'Authorization': API_KEY
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`Error authorizing agent: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('Agent authorized successfully:', data.token);
                    return data.token;
                } catch (error) {
                    console.error('Error authorizing agent:', error);
                    alert('Failed to authorize agent. Please try again.');
                }
            };

            const initConversation = async () => {
                try {
                    console.log('Initializing conversation...');
                    const agentId = await createAgent();
                    if (!agentId) return;

                    const sessionToken = await authorizeAgent(agentId);
                    if (!sessionToken) return;

                    console.log('Starting conversation with BlandWebClient...');
                    const blandClient = new BlandWebClient(agentId, sessionToken);
                    await blandClient.initConversation({
                        sampleRate: 44100,
                        onMicPermissionDenied: () => {
                            alert('Microphone access is required to start the conversation. Please allow microphone access and try again.');
                        }
                    });
                    console.log('Conversation initialized successfully.');
                } catch (error) {
                    console.error('Error initializing conversation:', error);
                    alert('Failed to start the conversation. Please try again.');
                }
            };

            document.getElementById('btn').addEventListener('click', initConversation);
        });
    </script>
</body>
</html>
