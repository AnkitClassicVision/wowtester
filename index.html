<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bland.ai Web Agent Widget</title>
    <script src="https://unpkg.com/bland-client-js-sdk@latest/dist/bland-client-js-sdk.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
</head>
<body>
    <div id="agent-widget">
        <button id="btn">Start Conversation</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_KEY = 'sk-vi2t1655977tdj9x96n3f0mmq878zkb00ph56z0gcuoyj2ditxnaaatg5l99yj4269';
            let agentId = null;
            let sessionToken = null;

            if (typeof BlandWebClient === 'undefined') {
                console.error('BlandWebClient is not defined. Please make sure the SDK script is loading correctly.');
                alert('Failed to load the Bland.ai SDK. Please check your internet connection and try again.');
                return;
            }

            const createAgent = async () => {
                try {
                    console.log('Creating agent...');
                    const options = {
                        method: 'POST',
                        headers: {
                            authorization: API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "pathway_id": "8929f3f6-c602-4b5a-a3d9-97d5639dea8e",
                            "prompt": "You are role-playing an optometry patient. Wait for a reply from the agent and then follow the pathway."
                        })
                    };

                    const response = await fetch('https://api.bland.ai/v1/agents', options);
                    if (!response.ok) {
                        throw new Error(`Error creating agent: ${response.statusText}`);
                    }
                    const data = await response.json();
                    agentId = data.agent.agent_id;
                    console.log('Agent created successfully:', agentId);
                } catch (error) {
                    console.error('Error creating agent:', error);
                    alert('Failed to create agent. Please try again.');
                }
            };

            const authorizeAgent = async () => {
                try {
                    console.log('Authorizing agent...');
                    const response = await fetch(`https://api.bland.ai/v1/agents/${agentId}/authorize`, {
                        method: 'POST',
                        headers: {
                            authorization: API_KEY
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`Error authorizing agent: ${response.statusText}`);
                    }
                    const data = await response.json();
                    sessionToken = data.token;
                    console.log('Agent authorized successfully:', sessionToken);
                } catch (error) {
                    console.error('Error authorizing agent:', error);
                    alert('Failed to authorize agent. Please try again.');
                }
            };

            const requestMicAccess = async () => {
                try {
                    console.log('Requesting microphone access...');
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Microphone access granted.');
                } catch (error) {
                    console.error('Microphone access denied:', error);
                    alert('Microphone access is required to start the conversation. Please allow microphone access and try again.');
                    throw error;
                }
            };

            const initConversation = async () => {
                try {
                    console.log('Initializing conversation...');
                    await requestMicAccess();

                    if (!agentId) {
                        await createAgent();
                    }
                    if (!sessionToken) {
                        await authorizeAgent();
                    }
                    if (!agentId || !sessionToken) {
                        console.error('Missing agentId or sessionToken');
                        alert('Failed to initialize the conversation due to missing agent ID or session token.');
                        return;
                    }

                    console.log('Starting conversation with BlandWebClient...');
                    const blandClient = new BlandWebClient(agentId, sessionToken);
                    await blandClient.initConversation({
                        sampleRate: 44100,
                        onMicPermissionDenied: () => {
                            alert('Microphone access is required to start the conversation. Please allow microphone access and try again.');
                        }
                    });
                    console.log('Conversation initialized successfully.');
                } catch (error) {
                    console.error('Error initializing conversation:', error);
                    alert('Failed to start the conversation. Please try again.');
                }
            };

            document.getElementById('btn').addEventListener('click', initConversation);
        });
    </script>
</body>
</html>
